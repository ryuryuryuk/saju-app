# WORKFLOW.md — 협업 프로토콜

> 두 AI 에이전트(Claude Code, Codex)가 병렬로 작업할 때 따르는 규칙입니다.

---

## 1. 역할 & 책임 (R/R)

### Claude Code — 백엔드 & 핵심 로직

| 책임 영역 | 파일 범위 | 구체적 업무 |
|-----------|----------|------------|
| API Routes | `app/api/**` | 엔드포인트 설계, 요청/응답 처리, 에러 핸들링 |
| 핵심 라이브러리 | `lib/**` | Supabase 클라이언트, 임베딩, 사주 계산 유틸 |
| 데이터 파이프라인 | `scripts/**` | 고서 텍스트 청킹, 벡터 인제스트, DB 마이그레이션 |
| 데이터 | `data/**` | 고서 원문 관리, 전처리 |
| 프롬프트 엔지니어링 | `app/api/**/route.*` 내부 | 시스템 프롬프트 설계 및 최적화 |
| DB 스키마 | Supabase Dashboard + `scripts/` | 테이블, RPC 함수, 인덱스 설계 |
| 환경설정 | `.env.local`, `next.config.*` | 환경 변수, Next.js 설정 |
| 서버 이슈 | - | 개발 서버, 빌드, 배포 관련 문제 해결 |

### Codex — 프론트엔드 & UI/UX

| 책임 영역 | 파일 범위 | 구체적 업무 |
|-----------|----------|------------|
| 페이지 | `app/page.tsx`, `app/**/page.tsx` | 페이지 구조, 라우팅 |
| 레이아웃 | `app/layout.tsx`, `app/**/layout.tsx` | 공통 레이아웃, 메타데이터 |
| 컴포넌트 | `app/components/**` | 재사용 UI 컴포넌트 설계 및 구현 |
| 스타일링 | `app/globals.css`, Tailwind 설정 | 디자인 시스템, 테마, 반응형 |
| 정적 자원 | `public/**` | 이미지, 폰트, 파비콘 |
| 클라이언트 로직 | 컴포넌트 내부 | 상태관리, 폼 핸들링, API 호출 로직 |
| 접근성/반응형 | 모든 FE 파일 | ARIA, 키보드, 모바일 대응 |
| 애니메이션 | 컴포넌트 내부 | 전환 효과, 로딩 상태, 마이크로 인터랙션 |

### 공유 영역 — 수정 전 반드시 협의

| 파일 | 소유권 충돌 이유 | 수정 절차 |
|------|----------------|----------|
| `app/page.tsx` | UI 구조(FE) + API 호출 인터페이스(BE) | HANDOFF.md에 변경 사항 기록 → 상대 확인 후 수정 |
| `package.json` | 양쪽 모두 의존성 추가 가능 | 추가할 패키지와 이유를 HANDOFF.md에 기록 |
| `tsconfig.json` | 컴파일 옵션이 양쪽에 영향 | 변경 전 HANDOFF.md에 사유 기록 |
| `docs/ai/*` | 협업 문서 자체 | 자기 섹션만 수정, 상대 섹션은 읽기 전용 |

---

## 2. 브랜치 전략

```
main                        ← 프로덕션 (직접 푸시 금지)
  └── develop               ← 통합 브랜치
       ├── feat/be-xxx      ← Claude Code 작업 브랜치
       └── feat/fe-xxx      ← Codex 작업 브랜치
```

### 브랜치 명명 규칙

| 에이전트 | 접두사 | 예시 |
|----------|--------|------|
| Claude Code | `feat/be-` | `feat/be-fix-dev-server`, `feat/be-complete-gapja-db` |
| Codex | `feat/fe-` | `feat/fe-redesign-form`, `feat/fe-result-animation` |

### 머지 플로우

```
1. 에이전트가 자기 브랜치에서 작업 완료
2. TASKS.md 상태 업데이트
3. HANDOFF.md에 완료 메시지 작성
4. 사용자가 develop으로 머지 (PR 또는 직접)
5. 상대 에이전트가 develop을 pull하고 계속 작업
```

---

## 3. 커밋 컨벤션

### 형식

```
[에이전트] 타입: 설명

본문 (선택)
```

### 에이전트 태그

| 태그 | 사용 |
|------|------|
| `[BE]` | Claude Code의 백엔드 작업 |
| `[FE]` | Codex의 프론트엔드 작업 |
| `[SHARED]` | 공유 파일 수정 (양쪽 모두 사용 가능) |

### 타입

| 타입 | 의미 |
|------|------|
| `feat` | 새 기능 |
| `fix` | 버그 수정 |
| `refactor` | 리팩토링 (기능 변경 없음) |
| `docs` | 문서 수정 |
| `chore` | 설정, 의존성 등 |

### 예시

```
[BE] feat: 60갑자 데이터 전체 완성
[FE] fix: 모바일에서 폼 입력 필드 잘리는 문제 해결
[SHARED] chore: framer-motion 의존성 추가
```

---

## 4. 작업 사이클 (각 에이전트 공통)

```
┌─────────────────────────────────────────────┐
│  [1] 세션 시작                                │
│      → docs/ai/CONTEXT.md 읽기               │
│      → docs/ai/TASKS.md 읽기                 │
│      → docs/ai/HANDOFF.md 읽기               │
│      → 상대 에이전트의 메시지/요청 확인         │
├─────────────────────────────────────────────┤
│  [2] 작업 선택                                │
│      → TASKS.md에서 자기 담당 중 우선순위 높은 것 │
│      → 상태를 🔵 진행중으로 변경               │
├─────────────────────────────────────────────┤
│  [3] 브랜치 생성 & 작업                       │
│      → develop에서 feat/be-xxx 분기            │
│      → 자기 담당 파일만 수정                   │
│      → 공유 파일 수정 필요 시 HANDOFF.md에 기록  │
├─────────────────────────────────────────────┤
│  [4] 작업 완료                                │
│      → 커밋 (컨벤션 준수)                      │
│      → TASKS.md 상태를 ✅ 완료로 변경           │
│      → HANDOFF.md에 완료 알림 & 전달 사항 기록   │
├─────────────────────────────────────────────┤
│  [5] 다음 작업 또는 세션 종료                   │
│      → [2]로 돌아가거나 사용자에게 보고          │
└─────────────────────────────────────────────┘
```

---

## 5. 충돌 방지 규칙

| # | 규칙 | 위반 시 |
|---|------|--------|
| 1 | 상대 담당 파일을 절대 수정하지 않는다 | 해당 커밋 revert |
| 2 | 공유 파일 수정 전 HANDOFF.md에 기록한다 | 충돌 발생 시 기록한 쪽 우선 |
| 3 | API 계약 변경 시 CONTEXT.md를 먼저 업데이트한다 | 상대 에이전트 작업 중단 위험 |
| 4 | package.json에 패키지 추가 시 이유를 커밋 메시지에 명시한다 | 사용자가 판단하여 제거 가능 |
| 5 | 같은 파일을 동시에 수정하지 않는다 (HANDOFF.md로 조율) | 수동 머지 필요 |

---

## 6. 에이전트 세션 시작 프롬프트

### Claude Code 세션 시작 시

```
다음 파일들을 읽고 Claude Code(백엔드) 역할로 작업을 시작하세요:
1. docs/ai/CONTEXT.md — 프로젝트 컨텍스트
2. docs/ai/TASKS.md — 현재 작업 현황
3. docs/ai/HANDOFF.md — Codex로부터 온 메시지 확인
4. CLAUDE.md — 전체 지침
```

### Codex 세션 시작 시

```
다음 파일들을 읽고 Codex(프론트엔드) 역할로 작업을 시작하세요:
1. docs/ai/CONTEXT.md — 프로젝트 컨텍스트
2. docs/ai/TASKS.md — 현재 작업 현황
3. docs/ai/HANDOFF.md — Claude Code로부터 온 메시지 확인
4. CLAUDE.md — 전체 지침
```
